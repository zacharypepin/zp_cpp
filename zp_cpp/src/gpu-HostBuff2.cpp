#include "zp_cpp/gpu.hpp"

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
void zp::gpu::HostBuff2::init(VkDevice device, VkPhysicalDevice phys_dev, size_t stride, uint32_t max_count, VkBufferUsageFlags usage)
{
    this->stride    = stride;
    this->max_count = max_count;
    util::create_buff(device, phys_dev, max_count * stride, usage, VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT | VK_MEMORY_PROPERTY_HOST_COHERENT_BIT, handle, memory);
    vkMapMemory(device, memory, 0, max_count * stride, 0, (void**)&p_mapped);
    count = 0;
}

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
zp::gpu::RegionHandle zp::gpu::HostBuff2::bump(uint32_t num)
{
    uint32_t new_count = count + num;
    if (new_count > max_count)
    {
        ERR("pushed past bounds: (" << new_count << " > " << max_count << ")");
    }

    RegionHandle region = {.ptr = p_mapped + count * stride, .start_idx = count, .count = num};
    count               = new_count;
    return region;
}

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
zp::gpu::RegionHandle zp::gpu::HostBuff2::push(std::byte* src, uint32_t num)
{
    uint32_t new_count = count + num;
    if (new_count > max_count)
    {
        ERR("pushed past bounds: (" << new_count << " > " << max_count << ")");
    }

    std::byte* p_region = p_mapped + count * stride;
    memcpy(p_region, src, num * stride);

    RegionHandle region = {.ptr = p_region, .start_idx = count, .count = num};
    count               = new_count;
    return region;
}

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
void zp::gpu::HostBuff2::remove(RegionHandle region)
{
    TODO("removing regions");
}

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
size_t zp::gpu::HostBuff2::size()
{
    return max_count * stride;
}

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
void zp::gpu::HostBuff2::reset()
{
    count = 0;
}

// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
// ====================================================================================================================
void zp::gpu::HostBuff2::cleanup(VkDevice device)
{
    reset();
    vkDestroyBuffer(device, handle, nullptr);
    vkFreeMemory(device, memory, nullptr);
}